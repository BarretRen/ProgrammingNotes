
# 1 可靠的字节流服务
TCP的特点是：面向连接、字节流、可靠传输：

- **发送应答机制**，每个发送的报文都必须得到接收方的应答，才认为是传输成功。
- 超时重传机制，发送每个报文胡会启动定时器，规定时间内没有疏导应答，就重发该报文。
- TCP对接收到的IP数据包进程重排、整理，保证不会乱序

TCP和UDP的传输结构如下：

![image.png](.assets/1605537271863-2a65409d-67ca-41d4-a84b-79888a49f98d.png)

# 2 TCP结构

## 2.1 头部结构
固定头部结构如下：![image.png](.assets/1605537451109-7879260b-a064-4cc4-8df9-309c05be2c84.png)

- 源端口号：表示报文来自哪里
- 目的端口号：报文传给哪个上层协议或应用程序
- 序号：一次TCP通信中某一个传输方向上字节流的每个字节的编号，保证不乱序
- 确认号：接收方的响应，下一次报文需要携带上一次的报文响应
- 窗口大小：告诉对方，本端接收缓冲区还能容纳多少字节

## 2.2 头部选项
TCP选项字段是可变长的可选信息，典型的选项如下：

![image.png](.assets/1605538213205-5cf1e3a9-5468-4e82-a320-6873ad607682.png)

# 3 TCP状态机
下图描述了所有的TCP状态和可能的状态转换（虚线表示服务器端的状态变化，实现表示客户端的状态变化）：

![image.png](.assets/1605538876615-ec85bb18-41fa-4b7d-b94f-335b11255d21.png)

# 4 带外数据
带外数据（Out Of Band），用于迅速告知对方本端发生的重要事件，比普通数据（**也叫带内数据**）优先级更高，应当立即发出。TCP在头部提供**紧急指针标志和紧急指针**两个字段，利用传输普通数据的连接来传输紧急数据。
发送端一次发送多字节的带外数据时，只有最后一个字节被当作带外数据，其他数据被当作普通数据，如下图结构：

![image.png](.assets/1605580587942-b7606ad8-0146-4326-af28-e1458090ec9f.png)

> 如果TCP设置了**SO_OOBINLINE**选项，则带外数据会被当作普通数据放在接收缓冲区，紧急指针仍然可以用于读取带外数据。



